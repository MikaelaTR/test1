@model AdvancedProjectMVC.Models.Channel

@{
    ViewData["Title"] = Model.ChannelName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container flex-parent">
    <div class="toolbar flex-child">
        <div class="toolbar_header">
            <h3>@Html.DisplayFor(model => model.Server.ServerName)</h3>
            @foreach (var item in Model.Server.Channels)
            {
                <a class="btn btn-primary toolbar_button rounded-lg" asp-controller="Channels" asp-action="Details" asp-route-id="@item.Id">
                    @Html.DisplayFor(item => item.ChannelName)
                </a>
            }

        </div>
        <div class="toolbar_buttons">
            <a asp-action="Create" class="btn btn-primary toolbar_button rounded-lg">Create Channel</a>
        </div>
    </div>
    <div class="mx-1 flex-child">
        <header class="px-3 text-start">
            @Html.DisplayFor(model => model.ChannelName)
        </header>
        <div>
            <a asp-controller="Servers" asp-action="Details" asp-route-id="@Model.ServerId" title="Back to server"><i class="btn btn-secondary btn-sm border-0 fa fa-long-arrow-left"></i></a>
        </div>

        <div class="container chat-area">
            <div id="messageArea" class="row">
                <div><p>Joined as: <b id="username">@User.Identity?.Name</b></p></div>
                <hr />
                <div class="row">
                    <div class="col-md-6 message-list-container">
                        <ul id="messageList" class="message-list">
                            @foreach (var item in Model.ChatMessages)
                            {
                                <li class="chat-message @((item.ApplicationUser.UserName == User.Identity?.Name) ? "chat-message--user" : "")">
                                    @Html.DisplayFor(modelItem => item.ApplicationUser.UserName)
                                    says:
                                    @Html.DisplayFor(modelItem => item.Content)
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <hr />
            </div>
            <div class="row chatbox">
                <div class="p-2 col-md-11">
                    <textarea type="text" id="message" autocomplete="off" onkeypress="enterKeySendMessage(event)" class="chatbox-textarea w-100"></textarea>
                </div>
                <div class="p-2 col-md-2 align-self-center">
                    <input type="button" id="sendButton" value="Send" onclick="sendMessage(event)" class="chatbox-sendbutton" />
                </div>
            </div>
        </div>
    </div>
</div>



<footer>
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
</footer>

<script>
    "use strict";
    const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").configureLogging(signalR.LogLevel.Trace).build();
    var username = document.getElementById("username").innerHTML;
    var channelId = @Model.Id;
    var groupName = "@Model.ChannelName";

    //Disable send button until connection is established
    document.getElementById("sendButton").disabled = true;

    connection.on("ReceiveMessage", function (user, message) {
        console.log("hey! Listen!");
        var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/</g, "&gt;");
        var encodedMsg = user + " says: " + msg;
        var li = document.createElement("li")
        li.textContent = encodedMsg;
        li.classList.add("chat-message");
        document.getElementById("messageList").appendChild(li);
        console.log("Over here!");
        window.scrollTo(0, document.body.scrollHeight); //Scroll to bottom of page when new message received
    });

    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
        addToGroup(groupName);
        console.log("Username: " + username + "\n");
        console.log("Channel: " + channelId + "\n");
    }).catch(function (err) {
        return console.error(err.toString());
    });

    function addToGroup(groupName) {
        connection.invoke("AddToGroup", groupName, username, channelId).then(function () {
            console.log(username + " has joined " + groupName + ".");
        }).catch(function (err) {
            return console.error(err.toString());
        });
    }

    function sendMessage(e) {
        var message = document.getElementById("message").value;
        if (message && message !== "\n") { //Don't send empty message
            connection.invoke("SendMessageToGroup", username, message, groupName, channelId).then(function () {
                document.getElementById("message").value = "";
            }).catch(function (err) {
                document.getElementById("message").value = "";
                return console.error(err.toString());
            });
            event.preventDefault();
        }
    }
    function enterKeySendMessage(e) { //Send message if enter key hit, and not holding shift
        if (e.code === "Enter" && !e.shiftKey) {
            sendMessage(e);
        }
    }

    //Resizes the text area to fit content
    const textArea = document.getElementById("message");
    textArea.style.cssText = `height: ${textArea.scrollHeight}px; overflow-y hidden`;
    textArea.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = `${this.scrollHeight}px`;
    });
    
    //Scroll to bottom of message list
    //NOT WORKING
    @*const delay = ms => new Promise(res => setTimeout(res, ms));
    const scrollToBottomMessageFunction = async () => {
        await delay(1000);
        console.log("Waited 1s");
        items = document.querySelectorAll(".chat-message");
        last = items[items.length - 1];
        last.scrollIntoView();
    };
    scrollToBottomMessageFunction();*@

</script>
